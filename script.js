document.addEventListener('DOMContentLoaded', () => {
    const scheduleContainer = document.getElementById('schedule');
    const searchInput = document.getElementById('search');
    let talks = [];

    fetch('talks.json')
        .then(response => response.json())
        .then(data => {
            talks = data;
            renderSchedule(talks);
        });

    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredTalks = talks.filter(talk => {
            return talk.category.some(category => category.toLowerCase().includes(searchTerm));
        });
        renderSchedule(filteredTalks);
    });

    function renderSchedule(talksToRender) {
        scheduleContainer.innerHTML = '';
        let currentTime = new Date();
        currentTime.setHours(10, 0, 0, 0);

        talksToRender.forEach((talk, index) => {
            const startTime = new Date(currentTime);
            const endTime = new Date(currentTime.getTime() + talk.duration * 60000);

            const scheduleItem = document.createElement('div');
            scheduleItem.classList.add('schedule-item');

            scheduleItem.innerHTML = `
                <div class="time">${formatTime(startTime)} - ${formatTime(endTime)}</div>
                <div class="title">${talk.title}</div>
                <div class="speakers"><strong>Speakers</strong> ${talk.speakers.join(', ')}</div>
                <div class="category">
                    ${talk.category.map(cat => `<span>${cat}</span>`).join('')}
                </div>
                <div class="description">${talk.description}</div>
            `;

            scheduleContainer.appendChild(scheduleItem);

            currentTime = new Date(endTime.getTime() + 10 * 60000); // 10 minute break

            if (index === 2) { // Add lunch break after the 3rd talk
                const lunchBreak = document.createElement('div');
                lunchBreak.classList.add('schedule-item', 'break');
                const lunchStartTime = new Date(currentTime);
                const lunchEndTime = new Date(currentTime.getTime() + 60 * 60000);
                lunchBreak.innerHTML = `
                    <div class="time">${formatTime(lunchStartTime)} - ${formatTime(lunchEndTime)}</div>
                    <div class="title">Lunch Break</div>
                ``;
                scheduleContainer.appendChild(lunchBreak);
                currentTime = lunchEndTime;
            }
        });
    }

    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
});
